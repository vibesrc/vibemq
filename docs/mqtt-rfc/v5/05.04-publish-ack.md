# Section 5.4: PUBACK, PUBREC, PUBREL, PUBCOMP

> This section is part of [Section 5: Control Packets](./05.01-connect.md).
> 
> - Previous: [Section 5.3: PUBLISH](./05.03-publish.md)
> - Next: [Section 5.5: SUBSCRIBE and SUBACK](./05.05-subscribe.md)

---

## 5.4.1 PUBACK – Publish Acknowledgment (QoS 1)

A PUBACK packet is the response to a PUBLISH packet with QoS 1.

### 5.4.1.1 Fixed Header

```
Bit         7   6   5   4   3   2   1   0
          ┌───────────────┬───────────────┐
byte 1    │  0   1   0   0│  0   0   0   0│  = 0x40
          └───────────────┴───────────────┘
byte 2+   │       Remaining Length        │
          └───────────────────────────────┘
```

### 5.4.1.2 Variable Header

1. **Packet Identifier** (2 bytes) - Same as PUBLISH
2. **Reason Code** (1 byte) - Can be omitted if 0x00 with no properties
3. **Properties**

### 5.4.1.3 PUBACK Reason Codes

| Value | Reason Code | Description |
|-------|-------------|-------------|
| 0x00 | Success | Message accepted |
| 0x10 | No matching subscribers | Message accepted but no subscribers |
| 0x80 | Unspecified error | Message not accepted |
| 0x83 | Implementation specific error | Message not accepted |
| 0x87 | Not authorized | Not authorized to publish |
| 0x90 | Topic Name invalid | Topic Name not valid |
| 0x91 | Packet Identifier in use | Packet ID already in use |
| 0x97 | Quota exceeded | Quota exceeded |
| 0x99 | Payload format invalid | Payload doesn't match indicator |

### 5.4.1.4 PUBACK Properties

| Property | ID | Type |
|----------|----|----- |
| Reason String | 0x1F | UTF-8 String |
| User Property | 0x26 | UTF-8 String Pair |

---

## 5.4.2 PUBREC – Publish Received (QoS 2 Part 1)

A PUBREC packet is the response to a PUBLISH packet with QoS 2. It is the second packet of the QoS 2 protocol exchange.

### 5.4.2.1 Fixed Header

```
Bit         7   6   5   4   3   2   1   0
          ┌───────────────┬───────────────┐
byte 1    │  0   1   0   1│  0   0   0   0│  = 0x50
          └───────────────┴───────────────┘
byte 2+   │       Remaining Length        │
          └───────────────────────────────┘
```

### 5.4.2.2 Variable Header

1. **Packet Identifier** (2 bytes)
2. **Reason Code** (1 byte) - Can be omitted if 0x00 with no properties
3. **Properties**

### 5.4.2.3 PUBREC Reason Codes

| Value | Reason Code | Description |
|-------|-------------|-------------|
| 0x00 | Success | Message accepted |
| 0x10 | No matching subscribers | Message accepted but no subscribers |
| 0x80 | Unspecified error | Message not accepted |
| 0x83 | Implementation specific error | Message not accepted |
| 0x87 | Not authorized | Not authorized to publish |
| 0x90 | Topic Name invalid | Topic Name not valid |
| 0x91 | Packet Identifier in use | Packet ID already in use |
| 0x97 | Quota exceeded | Quota exceeded |
| 0x99 | Payload format invalid | Payload doesn't match indicator |

> **Note:** If PUBREC contains a Reason Code >= 0x80, the sender MUST NOT send PUBREL and MUST consider the Packet Identifier available for reuse.

### 5.4.2.4 PUBREC Properties

| Property | ID | Type |
|----------|----|----- |
| Reason String | 0x1F | UTF-8 String |
| User Property | 0x26 | UTF-8 String Pair |

---

## 5.4.3 PUBREL – Publish Release (QoS 2 Part 2)

A PUBREL packet is the response to a PUBREC packet. It is the third packet of the QoS 2 protocol exchange.

### 5.4.3.1 Fixed Header

```
Bit         7   6   5   4   3   2   1   0
          ┌───────────────┬───────────────┐
byte 1    │  0   1   1   0│  0   0   1   0│  = 0x62
          └───────────────┴───────────────┘
byte 2+   │       Remaining Length        │
          └───────────────────────────────┘
```

**[MQTT-3.6.1-1]** Bits 3,2,1,0 MUST be set to 0,0,1,0 respectively. Any other value is a Malformed Packet.

### 5.4.3.2 Variable Header

1. **Packet Identifier** (2 bytes)
2. **Reason Code** (1 byte) - Can be omitted if 0x00 with no properties
3. **Properties**

### 5.4.3.3 PUBREL Reason Codes

| Value | Reason Code | Description |
|-------|-------------|-------------|
| 0x00 | Success | Message released |
| 0x92 | Packet Identifier not found | Unknown Packet ID |

### 5.4.3.4 PUBREL Properties

| Property | ID | Type |
|----------|----|----- |
| Reason String | 0x1F | UTF-8 String |
| User Property | 0x26 | UTF-8 String Pair |

---

## 5.4.4 PUBCOMP – Publish Complete (QoS 2 Part 3)

The PUBCOMP packet is the response to a PUBREL packet. It is the fourth and final packet of the QoS 2 protocol exchange.

### 5.4.4.1 Fixed Header

```
Bit         7   6   5   4   3   2   1   0
          ┌───────────────┬───────────────┐
byte 1    │  0   1   1   1│  0   0   0   0│  = 0x70
          └───────────────┴───────────────┘
byte 2+   │       Remaining Length        │
          └───────────────────────────────┘
```

### 5.4.4.2 Variable Header

1. **Packet Identifier** (2 bytes)
2. **Reason Code** (1 byte) - Can be omitted if 0x00 with no properties
3. **Properties**

### 5.4.4.3 PUBCOMP Reason Codes

| Value | Reason Code | Description |
|-------|-------------|-------------|
| 0x00 | Success | Publish complete |
| 0x92 | Packet Identifier not found | Unknown Packet ID |

### 5.4.4.4 PUBCOMP Properties

| Property | ID | Type |
|----------|----|----- |
| Reason String | 0x1F | UTF-8 String |
| User Property | 0x26 | UTF-8 String Pair |

---

## 5.4.5 QoS Protocol Flows

### QoS 1 Flow

```
    Sender                              Receiver
       │                                   │
       │  PUBLISH (QoS 1) ─────────────►  │
       │                                   │
       │  ◄─────────────────────── PUBACK │
       │                                   │
```

### QoS 2 Flow

```
    Sender                              Receiver
       │                                   │
       │  PUBLISH (QoS 2) ─────────────►  │  Store
       │                                   │
       │  ◄─────────────────────── PUBREC │
       │  Discard, store PUBREC            │
       │                                   │
       │  PUBREL ──────────────────────►  │  Deliver, discard
       │                                   │
       │  ◄────────────────────── PUBCOMP │
       │  Discard state                    │
       │                                   │
```

### QoS 2 with Error

```
    Sender                              Receiver
       │                                   │
       │  PUBLISH (QoS 2) ─────────────►  │
       │                                   │
       │  ◄─── PUBREC (Reason Code 0x87)  │  Not authorized
       │  Discard, ID available            │
       │                                   │
       │  (No PUBREL sent)                 │
       │                                   │
```

## 5.4.6 Minimal Packet Optimization

When Reason Code is 0x00 (Success) and there are no properties, the Reason Code and Property Length can be omitted:

### Minimal PUBACK (4 bytes):
```
0x40 0x02 <packet-id-msb> <packet-id-lsb>
```

### Full PUBACK (5+ bytes):
```
0x40 0x03 <packet-id-msb> <packet-id-lsb> <reason-code> <property-length> [properties]
```
