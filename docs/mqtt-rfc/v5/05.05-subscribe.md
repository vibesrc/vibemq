# Section 5.5: SUBSCRIBE and SUBACK

> This section is part of [Section 5: Control Packets](./05.01-connect.md).
> 
> - Previous: [Section 5.4: PUBACK, PUBREC, PUBREL, PUBCOMP](./05.04-publish-ack.md)
> - Next: [Section 5.6: UNSUBSCRIBE and UNSUBACK](./05.06-unsubscribe.md)

---

## 5.5.1 SUBSCRIBE – Subscribe Request

The SUBSCRIBE packet is sent from the Client to the Server to create one or more Subscriptions.

### 5.5.1.1 Fixed Header

```
Bit         7   6   5   4   3   2   1   0
          ┌───────────────┬───────────────┐
byte 1    │  1   0   0   0│  0   0   1   0│  = 0x82
          └───────────────┴───────────────┘
byte 2+   │       Remaining Length        │
          └───────────────────────────────┘
```

**[MQTT-3.8.1-1]** Bits 3,2,1,0 MUST be set to 0,0,1,0. Any other value is a Malformed Packet.

### 5.5.1.2 Variable Header

1. **Packet Identifier** (2 bytes)
2. **Properties**

### 5.5.1.3 SUBSCRIBE Properties

| Property | ID | Type | Description |
|----------|----|----- |-------------|
| Subscription Identifier | 0x0B | Variable Byte Integer | ID to include in matching PUBLISH |
| User Property | 0x26 | UTF-8 String Pair | Multiple allowed |

**[MQTT-3.8.2-1]** The Subscription Identifier MUST be a value from 1 to 268,435,455. Value 0 is a Protocol Error.

### 5.5.1.4 Payload

The Payload contains a list of Topic Filters with Subscription Options.

**[MQTT-3.8.3-1]** The Payload MUST contain at least one Topic Filter/Options pair. An empty payload is a Protocol Error.

### 5.5.1.5 Subscription Options

```
Bit     7   6     5       4       3-2       1-0
      ┌───┬───┬───────┬───────┬─────────┬─────────┐
      │Rsv│ NL│  RAP  │Retain │No Local │   QoS   │
      │(0)│   │       │Handle │         │         │
      └───┴───┴───────┴───────┴─────────┴─────────┘
```

| Field | Bits | Description |
|-------|------|-------------|
| QoS | 1-0 | Maximum QoS (0, 1, or 2) |
| No Local | 2 | Don't receive own publishes |
| Retain As Published | 3 | Keep original RETAIN flag |
| Retain Handling | 5-4 | When to send retained messages |
| Reserved | 7-6 | Must be 0 |

### Retain Handling Options

| Value | Description |
|-------|-------------|
| 0 | Send retained messages at subscribe time |
| 1 | Send retained only if subscription doesn't exist |
| 2 | Don't send retained messages at subscribe time |

**[MQTT-3.8.3-2]** If the No Local option is 1, the Server MUST NOT forward the Application Message to a connection with a ClientID equal to the publishing Client's ClientID.

**[MQTT-3.8.3-3]** Shared Subscriptions MUST have No Local set to 0. Setting it to 1 is a Protocol Error.

**[MQTT-3.8.3-4]** If Retain As Published is 1, the Server MUST set the RETAIN flag equal to the RETAIN flag in the received PUBLISH.

---

## 5.5.2 SUBACK – Subscribe Acknowledgment

A SUBACK packet is sent by the Server to the Client to confirm receipt of a SUBSCRIBE packet.

### 5.5.2.1 Fixed Header

```
Bit         7   6   5   4   3   2   1   0
          ┌───────────────┬───────────────┐
byte 1    │  1   0   0   1│  0   0   0   0│  = 0x90
          └───────────────┴───────────────┘
byte 2+   │       Remaining Length        │
          └───────────────────────────────┘
```

### 5.5.2.2 Variable Header

1. **Packet Identifier** (2 bytes) - Same as SUBSCRIBE
2. **Properties**

### 5.5.2.3 SUBACK Properties

| Property | ID | Type |
|----------|----|----- |
| Reason String | 0x1F | UTF-8 String |
| User Property | 0x26 | UTF-8 String Pair |

### 5.5.2.4 Payload

Contains a list of Reason Codes, one for each Topic Filter in the SUBSCRIBE.

**[MQTT-3.9.3-1]** The SUBACK Packet MUST contain a Reason Code for each Topic Filter.

### 5.5.2.5 SUBACK Reason Codes

| Value | Reason Code | Description |
|-------|-------------|-------------|
| 0x00 | Granted QoS 0 | Subscription accepted, max QoS 0 |
| 0x01 | Granted QoS 1 | Subscription accepted, max QoS 1 |
| 0x02 | Granted QoS 2 | Subscription accepted, max QoS 2 |
| 0x80 | Unspecified error | Subscription failed |
| 0x83 | Implementation specific error | Subscription failed |
| 0x87 | Not authorized | Not authorized for this topic |
| 0x8F | Topic Filter invalid | Malformed Topic Filter |
| 0x91 | Packet Identifier in use | Packet ID already in use |
| 0x97 | Quota exceeded | Quota exceeded |
| 0x9E | Shared Subscriptions not supported | Not supported |
| 0xA1 | Subscription Identifiers not supported | Not supported |
| 0xA2 | Wildcard Subscriptions not supported | Not supported |

---

## 5.5.3 SUBSCRIBE Actions

**[MQTT-3.8.4-1]** When the Server receives a SUBSCRIBE, it MUST respond with a SUBACK.

**[MQTT-3.8.4-2]** The SUBACK MUST have the same Packet Identifier as the SUBSCRIBE.

**[MQTT-3.8.4-3]** If a Server receives a SUBSCRIBE with a Topic Filter identical to an existing Subscription, it MUST completely replace that Subscription. Retained messages MUST be re-sent (based on Retain Handling), but the flow of publications MUST NOT be interrupted.

**[MQTT-3.8.4-4]** If a Server receives a SUBSCRIBE with multiple Topic Filters, it MUST handle each as if received separately, combining responses into a single SUBACK.

---

## 5.5.4 Example

### SUBSCRIBE with two topics:

```
Byte 1:    0x82  (SUBSCRIBE)
Byte 2:    0x12  (Remaining Length = 18)
Byte 3-4:  0x00, 0x0A  (Packet Identifier = 10)
Byte 5:    0x03  (Property Length = 3)
Byte 6:    0x0B  (Subscription Identifier property)
Byte 7-8:  0x03  (Subscription ID = 3, Variable Byte Integer)
Byte 9-10: 0x00, 0x05  (Topic Filter 1 Length = 5)
Byte 11-15: "a/b/c"  (Topic Filter 1)
Byte 16:   0x01  (Options: QoS 1)
Byte 17-18: 0x00, 0x01  (Topic Filter 2 Length = 1)
Byte 19:   "#"  (Topic Filter 2)
Byte 20:   0x02  (Options: QoS 2)
```

### SUBACK response:

```
Byte 1:    0x90  (SUBACK)
Byte 2:    0x05  (Remaining Length = 5)
Byte 3-4:  0x00, 0x0A  (Packet Identifier = 10)
Byte 5:    0x00  (Property Length = 0)
Byte 6:    0x01  (Reason Code for "a/b/c" = Granted QoS 1)
Byte 7:    0x02  (Reason Code for "#" = Granted QoS 2)
```
