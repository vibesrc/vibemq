# Section 5.3: PUBLISH – Publish Message

> This section is part of [Section 5: Control Packets](./05.01-connect.md).
> 
> - Previous: [Section 5.2: CONNACK](./05.02-connack.md)
> - Next: [Section 5.4: PUBACK, PUBREC, PUBREL, PUBCOMP](./05.04-publish-ack.md)

---

## 5.3.1 Overview

A PUBLISH packet is sent from a Client to a Server or from a Server to a Client to transport an Application Message.

## 5.3.2 Fixed Header

```
Bit         7   6   5   4   3   2   1   0
          ┌───────────────┬───┬───────┬───┐
byte 1    │  0   0   1   1│DUP│  QoS  │RET│
          └───────────────┴───┴───────┴───┘
byte 2+   │       Remaining Length        │
          └───────────────────────────────┘
```

### 5.3.2.1 DUP Flag (Bit 3)

**[MQTT-3.3.1-1]** The DUP flag MUST be set to 1 by the Client or Server when it attempts to re-deliver a PUBLISH packet.

**[MQTT-3.3.1-2]** The DUP flag MUST be set to 0 for all QoS 0 messages.

**[MQTT-3.3.1-3]** The DUP flag in the outgoing PUBLISH is set independently to the incoming PUBLISH; its value MUST be determined solely by whether the outgoing packet is a retransmission.

### 5.3.2.2 QoS (Bits 2-1)

| QoS Value | Bit 2 | Bit 1 | Description |
|-----------|-------|-------|-------------|
| 0 | 0 | 0 | At most once delivery |
| 1 | 0 | 1 | At least once delivery |
| 2 | 1 | 0 | Exactly once delivery |
| - | 1 | 1 | Reserved (Malformed Packet) |

**[MQTT-3.3.1-4]** A PUBLISH packet MUST NOT have both QoS bits set to 1. If a Server or Client receives a PUBLISH with both QoS bits set to 1 it is a Malformed Packet.

### 5.3.2.3 RETAIN Flag (Bit 0)

**[MQTT-3.3.1-5]** If RETAIN is set to 1 in a PUBLISH from Client to Server, the Server MUST replace any existing retained message for that topic and store the Application Message.

**[MQTT-3.3.1-6]** If the Payload is zero bytes and RETAIN is 1, any existing retained message for that topic MUST be removed and future subscribers will not receive a retained message for that topic.

**[MQTT-3.3.1-7]** A zero-byte retained message MUST NOT be stored as a retained message.

**[MQTT-3.3.1-8]** When sending a PUBLISH to a Client, the Server MUST set RETAIN to 1 if the message was sent as a result of a new subscription being made.

**[MQTT-3.3.1-9]** The Server MUST set RETAIN to 0 when a PUBLISH is sent because it matches an established subscription.

**[MQTT-3.3.1-10]** If RETAIN is 0 in a PUBLISH from Client to Server, the Server MUST NOT store the message as a retained message.

## 5.3.3 Variable Header

The Variable Header contains:
1. Topic Name (UTF-8 String)
2. Packet Identifier (if QoS > 0)
3. Properties

### 5.3.3.1 Topic Name

**[MQTT-3.3.2-1]** The Topic Name MUST be a UTF-8 Encoded String.

**[MQTT-3.3.2-2]** The Topic Name in a PUBLISH packet MUST NOT contain wildcard characters.

**[MQTT-3.3.2-3]** The Topic Name in a PUBLISH sent by Server to Client MUST match the Subscription's Topic Filter.

### 5.3.3.2 Packet Identifier

**[MQTT-3.3.2-4]** The Packet Identifier MUST be present if QoS > 0. It MUST NOT be present if QoS = 0.

### 5.3.3.3 PUBLISH Properties

| Property | ID | Type | Description |
|----------|----|----- |-------------|
| Payload Format Indicator | 0x01 | Byte | 0 = bytes, 1 = UTF-8 |
| Message Expiry Interval | 0x02 | Four Byte Integer | Lifetime in seconds |
| Topic Alias | 0x23 | Two Byte Integer | Topic alias value |
| Response Topic | 0x08 | UTF-8 String | For request/response |
| Correlation Data | 0x09 | Binary Data | For request/response |
| User Property | 0x26 | UTF-8 String Pair | Multiple allowed |
| Subscription Identifier | 0x0B | Variable Byte Integer | From matching subscription |
| Content Type | 0x03 | UTF-8 String | MIME type |

### 5.3.3.4 Topic Alias

Topic Alias allows replacing the Topic Name with a small integer to reduce packet size.

**Setting a Topic Alias:**
- Include both Topic Name and Topic Alias
- Server/Client stores mapping: Topic Alias → Topic Name

**Using a Topic Alias:**
- Include Topic Alias with zero-length Topic Name
- Receiver looks up Topic Name from stored mapping

**[MQTT-3.3.2-5]** A Topic Alias of 0 is not permitted. A Topic Alias greater than the maximum from CONNACK is a Protocol Error.

### 5.3.3.5 Subscription Identifier

When the Server delivers a PUBLISH to a Client, it MUST include the Subscription Identifier(s) from matching subscriptions that had Subscription Identifiers set.

Multiple Subscription Identifiers can be present if the message matches multiple subscriptions.

## 5.3.4 Payload

The Payload contains the Application Message being published. The content and format are application specific.

## 5.3.5 PUBLISH Actions

### 5.3.5.1 Client to Server

When a Client publishes:

1. Server validates Topic Name
2. Server checks authorization
3. Server stores retained message (if RETAIN = 1)
4. Server acknowledges (if QoS > 0)
5. Server distributes to matching subscribers

### 5.3.5.2 Server to Client

When a Server sends PUBLISH to a subscriber:

1. Apply QoS downgrade (min of publish QoS and subscription max QoS)
2. Set RETAIN appropriately (1 for new subscription, 0 otherwise)
3. Include Subscription Identifier(s) if present on subscription
4. Decrement and include Message Expiry Interval if originally present

### Table 5-2: QoS Response Requirements

| QoS | Response | Required |
|-----|----------|----------|
| 0 | None | N/A |
| 1 | PUBACK | Yes |
| 2 | PUBREC → PUBREL → PUBCOMP | Yes |

## 5.3.6 Examples

### QoS 0 PUBLISH:

```
Byte 1:    0x30  (PUBLISH, QoS 0, RETAIN 0)
Byte 2:    0x0E  (Remaining Length = 14)
Byte 3-4:  0x00, 0x05  (Topic Length = 5)
Byte 5-9:  "a/b/c"  (Topic Name)
Byte 10:   0x00  (Property Length = 0)
Byte 11-14: "test"  (Payload)
```

### QoS 1 PUBLISH with Topic Alias:

```
Byte 1:    0x32  (PUBLISH, QoS 1, RETAIN 0)
Byte 2:    0x0B  (Remaining Length = 11)
Byte 3-4:  0x00, 0x00  (Topic Length = 0, using alias)
Byte 5-6:  0x00, 0x0A  (Packet Identifier = 10)
Byte 7:    0x03  (Property Length = 3)
Byte 8:    0x23  (Topic Alias property)
Byte 9-10: 0x00, 0x01  (Topic Alias = 1)
Byte 11-14: "data"  (Payload)
```
