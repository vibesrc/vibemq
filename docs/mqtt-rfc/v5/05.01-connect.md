# Section 5.1: CONNECT – Connection Request

> This section is part of [Section 5: Control Packets](./05.01-connect.md).
> 
> - Next: [Section 5.2: CONNACK](./05.02-connack.md)

---

## 5.1.1 Overview

**[MQTT-3.1.0-1]** After a Network Connection is established by a Client to a Server, the first packet sent from the Client to the Server MUST be a CONNECT packet.

**[MQTT-3.1.0-2]** A Client can only send the CONNECT packet once over a Network Connection. The Server MUST process a second CONNECT packet sent from a Client as a Protocol Error and close the Network Connection.

The Payload contains one or more encoded fields. They specify a unique Client identifier for the Client, a Will Topic, Will Payload, User Name and Password. All but the Client identifier can be omitted.

## 5.1.2 Fixed Header

```
Bit         7   6   5   4   3   2   1   0
          ┌───────────────┬───────────────┐
byte 1    │  0   0   0   1│  0   0   0   0│  = 0x10
          └───────────────┴───────────────┘
byte 2+   │       Remaining Length        │
          └───────────────────────────────┘
```

## 5.1.3 Variable Header

The Variable Header contains fields in this order:
1. Protocol Name
2. Protocol Version
3. Connect Flags
4. Keep Alive
5. Properties

### 5.1.3.1 Protocol Name

```
byte 1-2:  Length = 4 (0x00, 0x04)
byte 3-6:  "MQTT" (0x4D, 0x51, 0x54, 0x54)
```

**[MQTT-3.1.2-1]** If the Server does not want to accept the CONNECT, and wishes to reveal that it is an MQTT Server it MAY send a CONNACK packet with Reason Code 0x84 (Unsupported Protocol Version), and then it MUST close the Network Connection.

### 5.1.3.2 Protocol Version

```
byte 7:    Version = 5 (0x05)
```

**[MQTT-3.1.2-2]** If the Protocol Version is not 5 and the Server does not want to accept the CONNECT packet, the Server MAY send a CONNACK packet with Reason Code 0x84 (Unsupported Protocol Version) and then MUST close the Network Connection.

### 5.1.3.3 Connect Flags

```
Bit     7         6         5       4-3       2        1         0
     ┌─────────┬─────────┬───────┬───────┬───────┬─────────┬──────────┐
     │Username │Password │ Will  │ Will  │ Will  │  Clean  │ Reserved │
     │  Flag   │  Flag   │Retain │  QoS  │ Flag  │  Start  │   (0)    │
     └─────────┴─────────┴───────┴───────┴───────┴─────────┴──────────┘
```

**[MQTT-3.1.2-3]** The Server MUST validate that the reserved flag is set to 0. If not 0 it is a Malformed Packet.

### 5.1.3.4 Clean Start

**Position:** bit 1

**[MQTT-3.1.2-4]** If Clean Start is set to 1, the Client and Server MUST discard any existing Session and start a new Session.

**[MQTT-3.1.2-5]** If Clean Start is set to 0 and there is a Session associated with the Client Identifier, the Server MUST resume communications based on state from the existing Session.

**[MQTT-3.1.2-6]** If Clean Start is set to 0 and there is no Session associated with the Client Identifier, the Server MUST create a new Session.

### 5.1.3.5 Will Flag

**Position:** bit 2

**[MQTT-3.1.2-7]** If the Will Flag is set to 1, a Will Message MUST be stored on the Server and associated with the Session.

**[MQTT-3.1.2-8]** The Will Message MUST be published after the Network Connection is subsequently closed and either the Will Delay Interval has elapsed or the Session ends, unless deleted by a normal DISCONNECT or a new connection.

**[MQTT-3.1.2-9]** If the Will Flag is set to 1, the Will Properties, Will Topic, and Will Payload fields MUST be present in the Payload.

**[MQTT-3.1.2-10]** The Will Message MUST be removed from stored Session State once it has been published or the Server has received a DISCONNECT with Reason Code 0x00.

### 5.1.3.6 Will QoS

**Position:** bits 4-3

**[MQTT-3.1.2-11]** If the Will Flag is set to 0, then the Will QoS MUST be set to 0.

**[MQTT-3.1.2-12]** If the Will Flag is set to 1, the value of Will QoS can be 0, 1, or 2. A value of 3 is a Malformed Packet.

### 5.1.3.7 Will Retain

**Position:** bit 5

**[MQTT-3.1.2-13]** If the Will Flag is set to 0, then Will Retain MUST be set to 0.

**[MQTT-3.1.2-14]** If Will Flag is 1 and Will Retain is 0, the Server MUST publish the Will Message as a non-retained message.

**[MQTT-3.1.2-15]** If Will Flag is 1 and Will Retain is 1, the Server MUST publish the Will Message as a retained message.

### 5.1.3.8 User Name Flag / Password Flag

**[MQTT-3.1.2-16]** If the User Name Flag is 0, a User Name MUST NOT be present in the Payload.

**[MQTT-3.1.2-17]** If the User Name Flag is 1, a User Name MUST be present in the Payload.

**[MQTT-3.1.2-18]** If the Password Flag is 0, a Password MUST NOT be present in the Payload.

**[MQTT-3.1.2-19]** If the Password Flag is 1, a Password MUST be present in the Payload.

> **Note:** MQTT 5.0 allows sending a Password without a User Name (unlike 3.1.1).

### 5.1.3.9 Keep Alive

Two Byte Integer representing the maximum interval in seconds between Control Packets.

**[MQTT-3.1.2-20]** If Keep Alive is non-zero and no other packets are sent, the Client MUST send a PINGREQ.

**[MQTT-3.1.2-21]** If the Server returns a Server Keep Alive in CONNACK, the Client MUST use that value instead.

**[MQTT-3.1.2-22]** If the Keep Alive is non-zero and the Server does not receive a packet within 1.5 times the Keep Alive period, it MUST close the Network Connection.

### 5.1.3.10 CONNECT Properties

| Property | ID | Type | Notes |
|----------|----|----- |-------|
| Session Expiry Interval | 0x11 | Four Byte Integer | Default 0 |
| Receive Maximum | 0x21 | Two Byte Integer | Default 65,535 |
| Maximum Packet Size | 0x27 | Four Byte Integer | Optional |
| Topic Alias Maximum | 0x22 | Two Byte Integer | Default 0 |
| Request Response Information | 0x19 | Byte | 0 or 1 |
| Request Problem Information | 0x17 | Byte | Default 1 |
| User Property | 0x26 | UTF-8 String Pair | Multiple allowed |
| Authentication Method | 0x15 | UTF-8 String | For enhanced auth |
| Authentication Data | 0x16 | Binary Data | For enhanced auth |

## 5.1.4 Payload

The Payload contains fields whose presence is determined by flags:

1. **Client Identifier** (Required)
2. **Will Properties** (If Will Flag = 1)
3. **Will Topic** (If Will Flag = 1)
4. **Will Payload** (If Will Flag = 1)
5. **User Name** (If User Name Flag = 1)
6. **Password** (If Password Flag = 1)

### 5.1.4.1 Client Identifier

UTF-8 Encoded String that uniquely identifies the Client.

**[MQTT-3.1.3-1]** The Server MUST allow ClientIds which are between 1 and 23 UTF-8 encoded bytes in length, and that contain only characters `0-9`, `a-z`, `A-Z`.

The Server MAY allow longer ClientIds or other characters.

**[MQTT-3.1.3-2]** If a zero-length ClientId is provided, the Server MUST assign a unique ClientId and return it in Assigned Client Identifier property.

**[MQTT-3.1.3-3]** If a zero-length ClientId is provided with Clean Start = 0, the Server MUST respond with Reason Code 0x85 (Client Identifier not valid).

### 5.1.4.2 Will Properties

| Property | ID | Type |
|----------|----|----- |
| Will Delay Interval | 0x18 | Four Byte Integer |
| Payload Format Indicator | 0x01 | Byte |
| Message Expiry Interval | 0x02 | Four Byte Integer |
| Content Type | 0x03 | UTF-8 String |
| Response Topic | 0x08 | UTF-8 String |
| Correlation Data | 0x09 | Binary Data |
| User Property | 0x26 | UTF-8 String Pair |

### 5.1.4.3 Will Topic and Payload

- Will Topic: UTF-8 Encoded String
- Will Payload: Binary Data

### 5.1.4.4 User Name and Password

- User Name: UTF-8 Encoded String
- Password: Binary Data

## 5.1.5 CONNECT Actions

Upon receiving CONNECT, the Server:

1. Validates packet structure
2. Checks protocol version
3. Validates Client Identifier
4. Authenticates (if required)
5. Handles existing session (Clean Start)
6. Stores Will Message (if present)
7. Sends CONNACK
