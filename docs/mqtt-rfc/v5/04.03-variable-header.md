# Section 4.3: Variable Header

> This section is part of [Section 4: Control Packet Format](./04.01-packet-structure.md).
> 
> - Previous: [Section 4.2: Fixed Header](./04.02-fixed-header.md)
> - Next: [Section 4.4: Properties](./04.04-properties.md)

---

## 4.3.1 Overview

Some types of MQTT Control Packet contain a Variable Header component. It resides between the Fixed Header and the Payload. The content of the Variable Header varies depending on the packet type.

In MQTT 5.0, the Variable Header of most packets includes a Properties section at the end.

## 4.3.2 Packet Identifier

The Variable Header of many MQTT Control Packet types includes a Two Byte Integer Packet Identifier field.

### Figure 4-3: Packet Identifier Format

```
Bit         7   6   5   4   3   2   1   0
          ┌───────────────────────────────┐
byte 1    │    Packet Identifier MSB      │
          ├───────────────────────────────┤
byte 2    │    Packet Identifier LSB      │
          └───────────────────────────────┘
```

### 4.3.2.1 Packets with Packet Identifier

### Table 4-6: Packet Identifier Requirements

| Packet | Packet Identifier |
|--------|-------------------|
| CONNECT | NO |
| CONNACK | NO |
| PUBLISH | YES (if QoS > 0) |
| PUBACK | YES |
| PUBREC | YES |
| PUBREL | YES |
| PUBCOMP | YES |
| SUBSCRIBE | YES |
| SUBACK | YES |
| UNSUBSCRIBE | YES |
| UNSUBACK | YES |
| PINGREQ | NO |
| PINGRESP | NO |
| DISCONNECT | NO |
| AUTH | NO |

### 4.3.2.2 Packet Identifier Requirements

**[MQTT-2.2.1-2]** A PUBLISH packet MUST NOT contain a Packet Identifier if its QoS value is set to 0.

**[MQTT-2.2.1-3]** Each time a Client sends a new SUBSCRIBE, UNSUBSCRIBE, or PUBLISH (where QoS > 0) MQTT Control Packet it MUST assign it a non-zero Packet Identifier that is currently unused.

**[MQTT-2.2.1-4]** Each time a Server sends a new PUBLISH (with QoS > 0) MQTT Control Packet it MUST assign it a non-zero Packet Identifier that is currently unused.

**[MQTT-2.2.1-5]** A PUBACK, PUBREC, PUBREL, or PUBCOMP packet MUST contain the same Packet Identifier as the PUBLISH packet that was originally sent.

**[MQTT-2.2.1-6]** A SUBACK and UNSUBACK MUST contain the Packet Identifier that was used in the corresponding SUBSCRIBE and UNSUBSCRIBE packet respectively.

### 4.3.2.3 Packet Identifier Lifecycle

The Packet Identifier becomes available for reuse after the sender has processed the corresponding acknowledgement packet:

| Original Packet | Acknowledgement | Identifier Released After |
|-----------------|-----------------|---------------------------|
| PUBLISH QoS 1 | PUBACK | PUBACK received |
| PUBLISH QoS 2 | PUBCOMP | PUBCOMP received |
| PUBLISH QoS 2 | PUBREC (error) | PUBREC with Reason Code ≥ 0x80 |
| SUBSCRIBE | SUBACK | SUBACK received |
| UNSUBSCRIBE | UNSUBACK | UNSUBACK received |

### 4.3.2.4 Packet Identifier Scope

Packet Identifiers used with PUBLISH, SUBSCRIBE, and UNSUBSCRIBE packets form a single, unified set of identifiers separately for the Client and the Server in a Session.

A Packet Identifier cannot be used by more than one command at any time.

The Client and Server assign Packet Identifiers independently. As a result, Client-Server pairs can participate in concurrent message exchanges using the same Packet Identifiers.

### Figure 4-4: Concurrent Packet Identifiers

```
    Client                              Server
       │                                   │
       │  PUBLISH (ID=0x1234) ─────────►  │
       │                                   │
       │  ◄───────── PUBLISH (ID=0x1234)  │  (Different message!)
       │                                   │
       │  PUBACK (ID=0x1234) ─────────►   │
       │                                   │
       │  ◄───────── PUBACK (ID=0x1234)   │
       │                                   │
```

## 4.3.3 Properties

The last field in the Variable Header of most MQTT 5.0 packets is a set of Properties. The set of Properties is composed of:

1. **Property Length** - A Variable Byte Integer indicating the total length of all properties
2. **Properties** - Zero or more Property fields

**[MQTT-2.2.2-1]** If there are no properties, this MUST be indicated by including a Property Length of zero.

See [Section 4.4: Properties](./04.04-properties.md) for the complete list of properties.

### Figure 4-5: Properties Structure

```
┌─────────────────────────────────────────┐
│   Property Length (Variable Byte Int)   │
├─────────────────────────────────────────┤
│   Property 1:                           │
│   - Identifier (Variable Byte Integer)  │
│   - Value (type-specific)               │
├─────────────────────────────────────────┤
│   Property 2:                           │
│   - Identifier (Variable Byte Integer)  │
│   - Value (type-specific)               │
├─────────────────────────────────────────┤
│   ... more properties                   │
└─────────────────────────────────────────┘
```

## 4.3.4 Variable Header Content by Packet Type

### Table 4-7: Variable Header Contents

| Packet | Variable Header Fields |
|--------|------------------------|
| CONNECT | Protocol Name, Protocol Version, Connect Flags, Keep Alive, Properties |
| CONNACK | Connect Acknowledge Flags, Reason Code, Properties |
| PUBLISH | Topic Name, Packet Identifier (if QoS > 0), Properties |
| PUBACK | Packet Identifier, Reason Code, Properties |
| PUBREC | Packet Identifier, Reason Code, Properties |
| PUBREL | Packet Identifier, Reason Code, Properties |
| PUBCOMP | Packet Identifier, Reason Code, Properties |
| SUBSCRIBE | Packet Identifier, Properties |
| SUBACK | Packet Identifier, Properties |
| UNSUBSCRIBE | Packet Identifier, Properties |
| UNSUBACK | Packet Identifier, Properties |
| PINGREQ | None |
| PINGRESP | None |
| DISCONNECT | Reason Code, Properties |
| AUTH | Reason Code, Properties |

> **Note:** In MQTT 5.0, acknowledgment packets (PUBACK, PUBREC, PUBREL, PUBCOMP, DISCONNECT, AUTH) include a Reason Code. For packets with success (Reason Code 0x00) and no properties, the Variable Header can be shortened.
