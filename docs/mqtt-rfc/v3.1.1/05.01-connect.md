# Section 5.1: CONNECT – Client Requests a Connection to a Server

> This section is part of [Section 5: Control Packets](./05.01-connect.md).
> 
> - Next: [Section 5.2: CONNACK](./05.02-connack.md)

---

## 5.1.1 Overview

After a Network Connection is established by a Client to a Server, the first Packet sent from the Client to the Server MUST be a CONNECT Packet. **[MQTT-3.1.0-1]**

**[MQTT-3.1.0-2]** A Client can only send the CONNECT Packet once over a Network Connection. The Server MUST process a second CONNECT Packet sent from a Client as a protocol violation and disconnect the Client.

The payload contains one or more encoded fields. They specify a unique Client identifier for the Client, a Will topic, Will Message, User Name and Password. All but the Client identifier are optional and their presence is determined based on flags in the variable header.

## 5.1.2 Fixed Header

### Figure 5-1: CONNECT Packet Fixed Header

```
Bit         7   6   5   4   3   2   1   0
          ┌───────────────┬───────────────┐
byte 1    │  0   0   0   1│  0   0   0   0│  = 0x10
          │  Packet Type  │   Reserved    │
          └───────────────┴───────────────┘
byte 2+   │       Remaining Length        │
          └───────────────────────────────┘
```

**Remaining Length:** Length of the Variable Header (10 bytes) plus the length of the Payload.

## 5.1.3 Variable Header

The variable header consists of four fields in the following order:

1. Protocol Name
2. Protocol Level
3. Connect Flags
4. Keep Alive

### 5.1.3.1 Protocol Name

### Table 5-1: Protocol Name Encoding

| Description | Byte | Value | Bits |
|-------------|------|-------|------|
| Length MSB | 1 | 0x00 | 00000000 |
| Length LSB | 2 | 0x04 | 00000100 |
| 'M' | 3 | 0x4D | 01001101 |
| 'Q' | 4 | 0x51 | 01010001 |
| 'T' | 5 | 0x54 | 01010100 |
| 'T' | 6 | 0x54 | 01010100 |

The Protocol Name is a UTF-8 encoded string "MQTT". This string, its offset, and length will not be changed by future versions of the MQTT specification.

**[MQTT-3.1.2-1]** If the protocol name is incorrect the Server MAY disconnect the Client, or it MAY continue processing the CONNECT packet in accordance with some other specification. In the latter case, the Server MUST NOT continue to process the CONNECT packet in line with this specification.

> **Note:** Packet inspectors, such as firewalls, could use the Protocol Name to identify MQTT traffic.

### 5.1.3.2 Protocol Level

### Table 5-2: Protocol Level Encoding

| Description | Byte | Value | Bits |
|-------------|------|-------|------|
| Level | 7 | 0x04 | 00000100 |

The 8-bit unsigned value represents the revision level of the protocol. The value for MQTT 3.1.1 is 4 (0x04).

**[MQTT-3.1.2-2]** The Server MUST respond to the CONNECT Packet with a CONNACK return code 0x01 (unacceptable protocol level) and then disconnect the Client if the Protocol Level is not supported by the Server.

### 5.1.3.3 Connect Flags

### Figure 5-2: Connect Flags

```
Bit         7   6   5   4   3   2   1   0
          ┌───┬───┬───┬───────┬───┬───┬───┐
byte 8    │ U │ P │ W │ Will  │ W │ C │ R │
          │ N │ F │ R │  QoS  │ F │ S │ e │
          │   │   │   │       │   │   │ s │
          └───┴───┴───┴───────┴───┴───┴───┘
```

| Bit | Name | Description |
|-----|------|-------------|
| 7 | User Name Flag | Username present in payload |
| 6 | Password Flag | Password present in payload |
| 5 | Will Retain | Retain Will Message |
| 4-3 | Will QoS | QoS for Will Message |
| 2 | Will Flag | Will Message present |
| 1 | Clean Session | Start fresh session |
| 0 | Reserved | MUST be 0 |

**[MQTT-3.1.2-3]** The Server MUST validate that the reserved flag in the CONNECT Control Packet is set to zero and disconnect the Client if it is not zero.

### 5.1.3.4 Clean Session

**Position:** bit 1 of the Connect Flags byte

This bit specifies the handling of the Session state.

**[MQTT-3.1.2-4]** If CleanSession is set to 0, the Server MUST resume communications with the Client based on state from the current Session (as identified by the Client identifier). If there is no Session associated with the Client identifier the Server MUST create a new Session. The Client and Server MUST store the Session after the Client and Server are disconnected.

**[MQTT-3.1.2-5]** After the disconnection of a Session that had CleanSession set to 0, the Server MUST store further QoS 1 and QoS 2 messages that match any subscriptions that the client had at the time of disconnection as part of the Session state. It MAY also store QoS 0 messages that meet the same criteria.

**[MQTT-3.1.2-6]** If CleanSession is set to 1, the Client and Server MUST discard any previous Session and start a new one. This Session lasts as long as the Network Connection. State data associated with this Session MUST NOT be reused in any subsequent Session.

**Session state in the Client:**
- QoS 1 and QoS 2 messages sent to Server, not yet fully acknowledged
- QoS 2 messages received from Server, not yet fully acknowledged

**Session state in the Server:**
- The existence of a Session, even if the rest of the Session state is empty
- The Client's subscriptions
- QoS 1 and QoS 2 messages sent to Client, not yet fully acknowledged
- QoS 1 and QoS 2 messages pending transmission to the Client
- QoS 2 messages received from Client, not yet fully acknowledged
- Optionally, QoS 0 messages pending transmission to the Client

**[MQTT-3.1.2-7]** Retained messages do not form part of the Session state in the Server, they MUST NOT be deleted when the Session ends.

### 5.1.3.5 Will Flag

**Position:** bit 2 of the Connect Flags

**[MQTT-3.1.2-8]** If the Will Flag is set to 1, a Will Message MUST be stored on the Server and associated with the Network Connection. The Will Message MUST be published when the Network Connection is subsequently closed unless the Will Message has been deleted by the Server on receipt of a DISCONNECT Packet.

Situations triggering Will Message publication:
- I/O error or network failure detected by the Server
- Client fails to communicate within the Keep Alive time
- Client closes Network Connection without DISCONNECT Packet
- Server closes Network Connection because of a protocol error

**[MQTT-3.1.2-9]** If the Will Flag is set to 1, the Will QoS and Will Retain fields will be used, and the Will Topic and Will Message fields MUST be present in the payload.

**[MQTT-3.1.2-10]** The Will Message MUST be removed from stored Session state once it has been published or the Server has received a DISCONNECT packet from the Client.

**[MQTT-3.1.2-11]** If the Will Flag is set to 0, the Will QoS and Will Retain fields MUST be set to zero and the Will Topic and Will Message fields MUST NOT be present in the payload.

**[MQTT-3.1.2-12]** If the Will Flag is set to 0, a Will Message MUST NOT be published when this Network Connection ends.

### 5.1.3.6 Will QoS

**Position:** bits 4 and 3 of the Connect Flags

These two bits specify the QoS level for the Will Message.

**[MQTT-3.1.2-13]** If the Will Flag is set to 0, then the Will QoS MUST be set to 0 (0x00).

**[MQTT-3.1.2-14]** If the Will Flag is set to 1, the value of Will QoS can be 0, 1, or 2. It MUST NOT be 3.

### 5.1.3.7 Will Retain

**Position:** bit 5 of the Connect Flags

**[MQTT-3.1.2-15]** If the Will Flag is set to 0, then the Will Retain Flag MUST be set to 0.

**[MQTT-3.1.2-16]** If Will Retain is 0 and Will Flag is 1, the Server MUST publish the Will Message as a non-retained message.

**[MQTT-3.1.2-17]** If Will Retain is 1 and Will Flag is 1, the Server MUST publish the Will Message as a retained message.

### 5.1.3.8 User Name Flag

**Position:** bit 7 of the Connect Flags

**[MQTT-3.1.2-18]** If the User Name Flag is set to 0, a user name MUST NOT be present in the payload.

**[MQTT-3.1.2-19]** If the User Name Flag is set to 1, a user name MUST be present in the payload.

### 5.1.3.9 Password Flag

**Position:** bit 6 of the Connect Flags

**[MQTT-3.1.2-20]** If the Password Flag is set to 0, a password MUST NOT be present in the payload.

**[MQTT-3.1.2-21]** If the Password Flag is set to 1, a password MUST be present in the payload.

**[MQTT-3.1.2-22]** If the User Name Flag is set to 0, the Password Flag MUST be set to 0.

### 5.1.3.10 Keep Alive

### Figure 5-3: Keep Alive Encoding

```
Bit         7   6   5   4   3   2   1   0
          ┌───────────────────────────────┐
byte 9    │       Keep Alive MSB          │
          ├───────────────────────────────┤
byte 10   │       Keep Alive LSB          │
          └───────────────────────────────┘
```

The Keep Alive is a time interval measured in seconds. It is the maximum time permitted between the point at which the Client finishes transmitting one Control Packet and the point it starts sending the next.

**[MQTT-3.1.2-23]** In the absence of sending any other Control Packets, the Client MUST send a PINGREQ Packet.

**[MQTT-3.1.2-24]** If the Keep Alive value is non-zero and the Server does not receive a Control Packet from the Client within one and a half times the Keep Alive time period, it MUST disconnect the Network Connection to the Client as if the network had failed.

A Keep Alive value of zero (0) turns off the keep alive mechanism. The Server is not required to disconnect the Client on the grounds of inactivity.

> **Note:** The maximum Keep Alive value is 65,535 seconds (18 hours 12 minutes 15 seconds).

## 5.1.4 Payload

The payload contains one or more length-prefixed fields, whose presence is determined by the flags in the variable header.

**[MQTT-3.1.3-1]** These fields, if present, MUST appear in the order: Client Identifier, Will Topic, Will Message, User Name, Password.

### 5.1.4.1 Client Identifier

**[MQTT-3.1.3-2]** The Client Identifier (ClientId) identifies the Client to the Server. Each Client connecting to the Server has a unique ClientId. The ClientId MUST be used by Clients and by Servers to identify state that they hold relating to this MQTT Session between the Client and the Server.

**[MQTT-3.1.3-3]** The Client Identifier MUST be present and MUST be the first field in the CONNECT packet payload.

**[MQTT-3.1.3-4]** The ClientId MUST be a UTF-8 encoded string.

**[MQTT-3.1.3-5]** The Server MUST allow ClientIds which are between 1 and 23 UTF-8 encoded bytes in length, and that contain only the characters: `0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ`

The Server MAY allow ClientIds that contain more than 23 encoded bytes or characters not in the list above.

**[MQTT-3.1.3-6]** A Server MAY allow a Client to supply a ClientId that has a length of zero bytes. If it does so, the Server MUST treat this as a special case and assign a unique ClientId to that Client. It MUST then process the CONNECT packet as if the Client had provided that unique ClientId.

**[MQTT-3.1.3-7]** If the Client supplies a zero-byte ClientId, the Client MUST also set CleanSession to 1.

**[MQTT-3.1.3-8]** If the Client supplies a zero-byte ClientId with CleanSession set to 0, the Server MUST respond with a CONNACK return code 0x02 (Identifier rejected) and then close the Network Connection.

**[MQTT-3.1.3-9]** If the Server rejects the ClientId it MUST respond with a CONNACK return code 0x02 (Identifier rejected) and then close the Network Connection.

### 5.1.4.2 Will Topic

If the Will Flag is set to 1, the Will Topic is the next field in the payload.

**[MQTT-3.1.3-10]** The Will Topic MUST be a UTF-8 encoded string.

### 5.1.4.3 Will Message

If the Will Flag is set to 1, the Will Message is the next field in the payload. The Will Message consists of a two-byte length followed by the payload for the Will Message.

### 5.1.4.4 User Name

If the User Name Flag is set to 1, this is the next field in the payload.

**[MQTT-3.1.3-11]** The User Name MUST be a UTF-8 encoded string. It can be used by the Server for authentication and authorization.

### 5.1.4.5 Password

If the Password Flag is set to 1, this is the next field in the payload. The Password field contains 0 to 65,535 bytes of binary data prefixed with a two-byte length field.

## 5.1.5 Response

**[MQTT-3.1.4-1]** The Server MUST validate that the CONNECT Packet conforms to section 3.1 and close the Network Connection without sending a CONNACK if it does not conform.

**[MQTT-3.1.4-2]** If the ClientId represents a Client already connected to the Server, the Server MUST disconnect the existing Client.

**[MQTT-3.1.4-3]** The Server MUST perform the processing of CleanSession as described in section 5.1.3.4.

**[MQTT-3.1.4-4]** The Server MUST acknowledge the CONNECT Packet with a CONNACK Packet containing a zero return code.

**[MQTT-3.1.4-5]** If the Server rejects the CONNECT, it MUST NOT process any data sent by the Client after the CONNECT Packet.

Clients are allowed to send further Control Packets immediately after sending a CONNECT Packet; Clients need not wait for a CONNACK Packet to arrive from the Server.

> **Note:** Clients typically wait for a CONNACK Packet. However, if the Client sends Control Packets before receiving CONNACK, it accepts that any data sent before CONNACK will not be processed if the Server rejects the connection.
