# Section 4.2: Fixed Header

> This section is part of [Section 4: Control Packet Format](./04.01-packet-structure.md).
> 
> - Previous: [Section 4.1: Packet Structure](./04.01-packet-structure.md)
> - Next: [Section 4.3: Variable Header](./04.03-variable-header.md)

---

## 4.2.1 Fixed Header Format

Each MQTT Control Packet contains a fixed header with the following structure:

### Figure 4-3: Fixed Header Format

```
Bit         7   6   5   4   3   2   1   0
          ┌───────────────┬───────────────┐
byte 1    │  Packet Type  │    Flags      │
          │   (bits 7-4)  │  (bits 3-0)   │
          └───────────────┴───────────────┘
byte 2+   │       Remaining Length        │
          │    (1 to 4 bytes variable)    │
          └───────────────────────────────┘
```

## 4.2.2 MQTT Control Packet Type

**Position:** byte 1, bits 7-4

Represented as a 4-bit unsigned value. The values are defined in [Table 4-2](./04.01-packet-structure.md#table-4-2-control-packet-types).

## 4.2.3 Flags

**Position:** byte 1, bits 3-0

The remaining bits [3-0] of byte 1 contain flags specific to each MQTT Control Packet type as listed below.

### Table 4-3: Fixed Header Flag Bits

| Control Packet | Bit 3 | Bit 2 | Bit 1 | Bit 0 | Description |
|----------------|-------|-------|-------|-------|-------------|
| CONNECT | 0 | 0 | 0 | 0 | Reserved |
| CONNACK | 0 | 0 | 0 | 0 | Reserved |
| PUBLISH | DUP | QoS | QoS | RETAIN | See below |
| PUBACK | 0 | 0 | 0 | 0 | Reserved |
| PUBREC | 0 | 0 | 0 | 0 | Reserved |
| PUBREL | 0 | 0 | 1 | 0 | Reserved |
| PUBCOMP | 0 | 0 | 0 | 0 | Reserved |
| SUBSCRIBE | 0 | 0 | 1 | 0 | Reserved |
| SUBACK | 0 | 0 | 0 | 0 | Reserved |
| UNSUBSCRIBE | 0 | 0 | 1 | 0 | Reserved |
| UNSUBACK | 0 | 0 | 0 | 0 | Reserved |
| PINGREQ | 0 | 0 | 0 | 0 | Reserved |
| PINGRESP | 0 | 0 | 0 | 0 | Reserved |
| DISCONNECT | 0 | 0 | 0 | 0 | Reserved |

**[MQTT-2.2.2-1]** Where a flag bit is marked as "Reserved", it is reserved for future use and MUST be set to the value listed in the table above.

**[MQTT-2.2.2-2]** If invalid flags are received, the receiver MUST close the Network Connection.

See [Section 5.3](./05.03-publish.md) for a description of the DUP, QoS, and RETAIN flags in the PUBLISH Control Packet.

### PUBLISH Flags Detail

| Flag | Bit(s) | Description |
|------|--------|-------------|
| DUP | 3 | Duplicate delivery of a PUBLISH Control Packet |
| QoS | 2-1 | PUBLISH Quality of Service |
| RETAIN | 0 | PUBLISH Retain flag |

## 4.2.4 Remaining Length

**Position:** starts at byte 2

The Remaining Length is the number of bytes remaining within the current packet, including data in the variable header and the payload. The Remaining Length does NOT include the bytes used to encode the Remaining Length itself.

### 4.2.4.1 Variable Length Encoding

The Remaining Length is encoded using a variable length encoding scheme which uses a single byte for values up to 127. Larger values are handled as follows:

- The least significant seven bits of each byte encode the data
- The most significant bit (bit 7) is a continuation bit indicating more bytes follow
- Maximum of four bytes in the Remaining Length field

### Table 4-4: Remaining Length Encoding Ranges

| Bytes | Minimum Value | Maximum Value | Wire Format (Max) |
|-------|---------------|---------------|-------------------|
| 1 | 0 | 127 | 0x7F |
| 2 | 128 | 16,383 | 0xFF, 0x7F |
| 3 | 16,384 | 2,097,151 | 0xFF, 0xFF, 0x7F |
| 4 | 2,097,152 | 268,435,455 | 0xFF, 0xFF, 0xFF, 0x7F |

> **Note:** This allows applications to send Control Packets of size up to 268,435,455 (256 MB).

### 4.2.4.2 Encoding Algorithm

```
do
    encodedByte = X MOD 128
    X = X DIV 128
    // if there are more data to encode, set the top bit of this byte
    if (X > 0)
        encodedByte = encodedByte OR 128
    endif
    'output' encodedByte
while (X > 0)
```

Where:
- `MOD` is the modulo operator (`%` in C)
- `DIV` is integer division (`/` in C)
- `OR` is bit-wise or (`|` in C)

### 4.2.4.3 Decoding Algorithm

```
multiplier = 1
value = 0
do
    encodedByte = 'next byte from stream'
    value += (encodedByte AND 127) * multiplier
    multiplier *= 128
    if (multiplier > 128*128*128)
        throw Error(Malformed Remaining Length)
while ((encodedByte AND 128) != 0)
```

Where `AND` is the bit-wise and operator (`&` in C).

When this algorithm terminates, `value` contains the Remaining Length value.

### 4.2.4.4 Encoding Examples

**Example 1:** Remaining Length = 64

```
64 decimal = 0x40
Wire format: 0x40 (single byte, bit 7 = 0)
```

**Example 2:** Remaining Length = 321

```
321 = 65 + (2 × 128)
First byte:  65 + 128 = 193 = 0xC1 (continuation bit set)
Second byte: 2 = 0x02 (no continuation)
Wire format: 0xC1, 0x02
```

**Example 3:** Maximum value = 268,435,455

```
Wire format: 0xFF, 0xFF, 0xFF, 0x7F
```

## 4.2.5 Fixed Header Examples

### Table 4-5: Fixed Header Examples

| Packet Type | Byte 1 | Remaining Length | Total Fixed Header |
|-------------|--------|------------------|-------------------|
| CONNECT | 0x10 | Variable | 2+ bytes |
| CONNACK | 0x20 | 0x02 | 2 bytes |
| PUBLISH QoS 0 | 0x30 | Variable | 2+ bytes |
| PUBLISH QoS 1 | 0x32 | Variable | 2+ bytes |
| PUBLISH QoS 2 | 0x34 | Variable | 2+ bytes |
| PUBACK | 0x40 | 0x02 | 2 bytes |
| SUBSCRIBE | 0x82 | Variable | 2+ bytes |
| PINGREQ | 0xC0 | 0x00 | 2 bytes |
| DISCONNECT | 0xE0 | 0x00 | 2 bytes |
