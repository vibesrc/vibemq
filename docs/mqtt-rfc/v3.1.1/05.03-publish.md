# Section 5.3: PUBLISH – Publish Message

> This section is part of [Section 5: Control Packets](./05.01-connect.md).
> 
> - Previous: [Section 5.2: CONNACK](./05.02-connack.md)
> - Next: [Section 5.4: PUBACK, PUBREC, PUBREL, PUBCOMP](./05.04-publish-ack.md)

---

## 5.3.1 Overview

A PUBLISH Control Packet is sent from a Client to a Server or from Server to a Client to transport an Application Message.

## 5.3.2 Fixed Header

### Figure 5-7: PUBLISH Packet Fixed Header

```
Bit         7   6   5   4   3   2   1   0
          ┌───────────────┬───┬───────┬───┐
byte 1    │  0   0   1   1│DUP│  QoS  │RET│  = 0x3X
          │  Packet Type  │   │       │   │
          └───────────────┴───┴───────┴───┘
byte 2+   │       Remaining Length        │
          └───────────────────────────────┘
```

### 5.3.2.1 DUP Flag

**Position:** byte 1, bit 3

If the DUP flag is set to 0, it indicates that this is the first occasion that the Client or Server has attempted to send this MQTT PUBLISH Packet.

If the DUP flag is set to 1, it indicates that this might be re-delivery of an earlier attempt to send the Packet.

**[MQTT-3.3.1-1]** The DUP flag MUST be set to 1 by the Client or Server when it attempts to re-deliver a PUBLISH Packet.

**[MQTT-3.3.1-2]** The DUP flag MUST be set to 0 for all QoS 0 messages.

**[MQTT-3.3.1-3]** The value of the DUP flag from an incoming PUBLISH packet is not propagated when the PUBLISH Packet is sent to subscribers by the Server. The DUP flag in the outgoing PUBLISH packet is set independently to the incoming PUBLISH packet; its value MUST be determined solely by whether the outgoing PUBLISH packet is a retransmission.

> **Note:** The recipient of a Control Packet with DUP set to 1 cannot assume that it has seen an earlier copy of this packet.

> **Note:** The DUP flag refers to the Control Packet itself, not to the Application Message. When using QoS 1, a Client might receive a PUBLISH Packet with DUP=0 containing a repetition of an Application Message it received earlier, but with a different Packet Identifier.

### 5.3.2.2 QoS

**Position:** byte 1, bits 2-1

This field indicates the level of assurance for delivery of an Application Message.

### Table 5-4: QoS Definitions

| QoS Value | Bit 2 | Bit 1 | Description |
|-----------|-------|-------|-------------|
| 0 | 0 | 0 | At most once delivery |
| 1 | 0 | 1 | At least once delivery |
| 2 | 1 | 0 | Exactly once delivery |
| - | 1 | 1 | Reserved – MUST NOT be used |

**[MQTT-3.3.1-4]** A PUBLISH Packet MUST NOT have both QoS bits set to 1. If a Server or Client receives a PUBLISH Packet which has both QoS bits set to 1 it MUST close the Network Connection.

See [Section 7: Quality of Service](./07-qos.md) for detailed QoS semantics.

### 5.3.2.3 RETAIN

**Position:** byte 1, bit 0

**[MQTT-3.3.1-5]** If the RETAIN flag is set to 1 in a PUBLISH Packet sent by a Client to a Server, the Server MUST store the Application Message and its QoS, so that it can be delivered to future subscribers whose subscriptions match its topic name.

**[MQTT-3.3.1-6]** When a new subscription is established, the last retained message, if any, on each matching topic name MUST be sent to the subscriber.

**[MQTT-3.3.1-7]** If the Server receives a QoS 0 message with the RETAIN flag set to 1, it MUST discard any message previously retained for that topic. It SHOULD store the new QoS 0 message as the new retained message for that topic, but MAY choose to discard it at any time.

**[MQTT-3.3.1-8]** When sending a PUBLISH Packet to a Client, the Server MUST set the RETAIN flag to 1 if a message is sent as a result of a new subscription being made by a Client.

**[MQTT-3.3.1-9]** The Server MUST set the RETAIN flag to 0 when a PUBLISH Packet is sent to a Client because it matches an established subscription regardless of how the flag was set in the message it received.

**[MQTT-3.3.1-10]** A PUBLISH Packet with RETAIN flag set to 1 and a zero-length payload will be processed normally and sent to Clients with matching subscriptions. Additionally any existing retained message with the same topic name MUST be removed and any future subscribers for the topic will not receive a retained message.

**[MQTT-3.3.1-11]** A zero byte retained message MUST NOT be stored as a retained message on the Server.

**[MQTT-3.3.1-12]** If the RETAIN flag is 0 in a PUBLISH Packet sent by a Client to a Server, the Server MUST NOT store the message and MUST NOT remove or replace any existing retained message.

> **Note:** Retained messages are useful where publishers send state messages on an irregular basis. A new subscriber will receive the most recent state.

## 5.3.3 Variable Header

The variable header contains the following fields in order:

1. Topic Name
2. Packet Identifier (if QoS > 0)

### 5.3.3.1 Topic Name

**[MQTT-3.3.2-1]** The Topic Name MUST be present as the first field in the PUBLISH Packet Variable header. It MUST be a UTF-8 encoded string.

**[MQTT-3.3.2-2]** The Topic Name in the PUBLISH Packet MUST NOT contain wildcard characters.

**[MQTT-3.3.2-3]** The Topic Name in a PUBLISH Packet sent by a Server to a subscribing Client MUST match the Subscription's Topic Filter according to the matching process defined in [Section 8](./08-topics.md).

### 5.3.3.2 Packet Identifier

The Packet Identifier field is only present in PUBLISH Packets where the QoS level is 1 or 2. See [Section 4.3](./04.03-variable-header.md) for more information.

### Figure 5-8: PUBLISH Variable Header Example

```
Topic Name "a/b" with Packet Identifier 10:

Byte 1: 0x00  (Topic Length MSB)
Byte 2: 0x03  (Topic Length LSB = 3)
Byte 3: 0x61  ('a')
Byte 4: 0x2F  ('/')
Byte 5: 0x62  ('b')
Byte 6: 0x00  (Packet Identifier MSB)
Byte 7: 0x0A  (Packet Identifier LSB = 10)
```

## 5.3.4 Payload

The Payload contains the Application Message that is being published. The content and format of the data is application specific.

The length of the payload can be calculated by subtracting the length of the variable header from the Remaining Length field in the Fixed Header.

It is valid for a PUBLISH Packet to contain a zero-length payload.

## 5.3.5 Response

**[MQTT-3.3.4-1]** The receiver of a PUBLISH Packet MUST respond according to the QoS:

### Table 5-5: Expected PUBLISH Responses

| QoS Level | Expected Response |
|-----------|-------------------|
| QoS 0 | None |
| QoS 1 | PUBACK Packet |
| QoS 2 | PUBREC Packet |

## 5.3.6 Actions

The Client uses a PUBLISH Packet to send an Application Message to the Server for distribution to Clients with matching subscriptions.

The Server uses a PUBLISH Packet to send an Application Message to each Client which has a matching subscription.

**[MQTT-3.3.5-1]** When Clients make subscriptions with Topic Filters that include wildcards, it is possible for a Client's subscriptions to overlap. In this case, the Server MUST deliver the message to the Client respecting the maximum QoS of all the matching subscriptions. The Server MAY deliver further copies of the message for each additional matching subscription.

**[MQTT-3.3.5-2]** If a Server implementation does not authorize a PUBLISH to be performed by a Client, it has no way of informing that Client. It MUST either make a positive acknowledgement according to the normal QoS rules, or close the Network Connection.

## 5.3.7 Wire Format Examples

### Example 1: QoS 0 PUBLISH

```
Topic: "sensors/temp"
Payload: "22.5"

Byte 1: 0x30  (PUBLISH, QoS 0, DUP=0, RETAIN=0)
Byte 2: 0x10  (Remaining Length = 16)
Byte 3: 0x00  (Topic Length MSB)
Byte 4: 0x0C  (Topic Length LSB = 12)
Bytes 5-16: "sensors/temp"
Bytes 17-20: "22.5" (payload)
```

### Example 2: QoS 1 PUBLISH with RETAIN

```
Topic: "status"
Payload: "online"
Packet ID: 1

Byte 1: 0x33  (PUBLISH, QoS 1, DUP=0, RETAIN=1)
Byte 2: 0x0E  (Remaining Length = 14)
Byte 3: 0x00  (Topic Length MSB)
Byte 4: 0x06  (Topic Length LSB = 6)
Bytes 5-10: "status"
Byte 11: 0x00 (Packet ID MSB)
Byte 12: 0x01 (Packet ID LSB = 1)
Bytes 13-18: "online" (payload)
```
