# Section 5.5: SUBSCRIBE and SUBACK

> This section is part of [Section 5: Control Packets](./05.01-connect.md).
> 
> - Previous: [Section 5.4: PUBACK, PUBREC, PUBREL, PUBCOMP](./05.04-publish-ack.md)
> - Next: [Section 5.6: UNSUBSCRIBE and UNSUBACK](./05.06-unsubscribe.md)

---

## 5.5.1 SUBSCRIBE – Subscribe to Topics

The SUBSCRIBE Packet is sent from the Client to the Server to create one or more Subscriptions. Each Subscription registers a Client's interest in one or more Topics. The Server sends PUBLISH Packets to the Client to forward Application Messages that were published to Topics that match these Subscriptions. The SUBSCRIBE Packet also specifies the maximum QoS with which the Server can send Application Messages to the Client.

### 5.5.1.1 Fixed Header

### Figure 5-18: SUBSCRIBE Packet Fixed Header

```
Bit         7   6   5   4   3   2   1   0
          ┌───────────────┬───────────────┐
byte 1    │  1   0   0   0│  0   0   1   0│  = 0x82
          │  Packet Type  │   Reserved    │
          └───────────────┴───────────────┘
byte 2+   │       Remaining Length        │
          └───────────────────────────────┘
```

**[MQTT-3.8.1-1]** Bits 3,2,1,0 of the fixed header of the SUBSCRIBE Control Packet are reserved and MUST be set to 0,0,1,0 respectively. The Server MUST treat any other value as malformed and close the Network Connection.

**Remaining Length:** Length of variable header (2 bytes) plus the length of the payload.

### 5.5.1.2 Variable Header

The variable header contains a Packet Identifier.

### Figure 5-19: SUBSCRIBE Variable Header

```
Bit         7   6   5   4   3   2   1   0
          ┌───────────────────────────────┐
byte 1    │    Packet Identifier MSB      │
          ├───────────────────────────────┤
byte 2    │    Packet Identifier LSB      │
          └───────────────────────────────┘
```

### 5.5.1.3 Payload

The payload contains a list of Topic Filters indicating the Topics to which the Client wants to subscribe.

**[MQTT-3.8.3-1]** The Topic Filters in a SUBSCRIBE packet payload MUST be UTF-8 encoded strings.

**[MQTT-3.8.3-2]** A Server SHOULD support Topic filters that contain the wildcard characters defined in [Section 8](./08-topics.md). If it chooses not to support topic filters that contain wildcard characters it MUST reject any Subscription request whose filter contains them.

Each filter is followed by a byte called the Requested QoS. This gives the maximum QoS level at which the Server can send Application Messages to the Client.

**[MQTT-3.8.3-3]** The payload of a SUBSCRIBE packet MUST contain at least one Topic Filter / QoS pair. A SUBSCRIBE packet with no payload is a protocol violation.

### Figure 5-20: SUBSCRIBE Payload Format

```
┌─────────────────────────────────────────────────┐
│     Topic Filter Length MSB                     │
├─────────────────────────────────────────────────┤
│     Topic Filter Length LSB                     │
├─────────────────────────────────────────────────┤
│     Topic Filter (UTF-8 encoded)                │
│     ... (length bytes)                          │
├─────────────────────────────────────────────────┤
│     Requested QoS                               │
│     (Reserved: bits 7-2, QoS: bits 1-0)         │
├─────────────────────────────────────────────────┤
│     ... more Topic Filter / QoS pairs           │
└─────────────────────────────────────────────────┘
```

**[MQTT-3.8.3-4]** The Server MUST treat a SUBSCRIBE packet as malformed and close the Network Connection if any of the Reserved bits in the payload are non-zero, or if QoS is not 0, 1, or 2.

### Table 5-7: Requested QoS Byte

| Bit | Description |
|-----|-------------|
| 7-2 | Reserved (MUST be 0) |
| 1-0 | Maximum QoS (0, 1, or 2) |

### 5.5.1.4 Example Payload

Subscribing to topics "a/b" with QoS 1 and "c/d" with QoS 2:

### Table 5-8: SUBSCRIBE Payload Example

| Byte | Value | Description |
|------|-------|-------------|
| 1 | 0x00 | Topic Filter 1 Length MSB |
| 2 | 0x03 | Topic Filter 1 Length LSB (3) |
| 3 | 0x61 | 'a' |
| 4 | 0x2F | '/' |
| 5 | 0x62 | 'b' |
| 6 | 0x01 | Requested QoS (1) |
| 7 | 0x00 | Topic Filter 2 Length MSB |
| 8 | 0x03 | Topic Filter 2 Length LSB (3) |
| 9 | 0x63 | 'c' |
| 10 | 0x2F | '/' |
| 11 | 0x64 | 'd' |
| 12 | 0x02 | Requested QoS (2) |

---

## 5.5.2 SUBSCRIBE Response

**[MQTT-3.8.4-1]** When the Server receives a SUBSCRIBE Packet from a Client, the Server MUST respond with a SUBACK Packet.

**[MQTT-3.8.4-2]** The SUBACK Packet MUST have the same Packet Identifier as the SUBSCRIBE Packet that it is acknowledging.

The Server is permitted to start sending PUBLISH packets matching the Subscription before the Server sends the SUBACK Packet.

**[MQTT-3.8.4-3]** If a Server receives a SUBSCRIBE Packet containing a Topic Filter that is identical to an existing Subscription's Topic Filter then it MUST completely replace that existing Subscription with a new Subscription. The Topic Filter in the new Subscription will be identical to that in the previous Subscription, although its maximum QoS value could be different. Any existing retained messages matching the Topic Filter MUST be re-sent, but the flow of publications MUST NOT be interrupted.

**[MQTT-3.8.4-4]** If a Server receives a SUBSCRIBE packet that contains multiple Topic Filters it MUST handle that packet as if it had received a sequence of multiple SUBSCRIBE packets, except that it combines their responses into a single SUBACK response.

**[MQTT-3.8.4-5]** The SUBACK Packet sent by the Server to the Client MUST contain a return code for each Topic Filter/QoS pair. This return code MUST either show the maximum QoS that was granted for that Subscription or indicate that the subscription failed.

---

## 5.5.3 SUBACK – Subscribe Acknowledgement

A SUBACK Packet is sent by the Server to the Client to confirm receipt and processing of a SUBSCRIBE Packet.

### 5.5.3.1 Fixed Header

### Figure 5-21: SUBACK Packet Fixed Header

```
Bit         7   6   5   4   3   2   1   0
          ┌───────────────┬───────────────┐
byte 1    │  1   0   0   1│  0   0   0   0│  = 0x90
          │  Packet Type  │   Reserved    │
          └───────────────┴───────────────┘
byte 2+   │       Remaining Length        │
          └───────────────────────────────┘
```

### 5.5.3.2 Variable Header

The variable header contains the Packet Identifier from the SUBSCRIBE Packet.

### Figure 5-22: SUBACK Variable Header

```
Bit         7   6   5   4   3   2   1   0
          ┌───────────────────────────────┐
byte 1    │    Packet Identifier MSB      │
          ├───────────────────────────────┤
byte 2    │    Packet Identifier LSB      │
          └───────────────────────────────┘
```

### 5.5.3.3 Payload

The payload contains a list of return codes corresponding to each Topic Filter in the SUBSCRIBE request.

### Figure 5-23: SUBACK Payload Format

```
Bit         7   6   5   4   3   2   1   0
          ┌───────────────────────────────┐
byte 1    │        Return Code 1          │
          ├───────────────────────────────┤
byte 2    │        Return Code 2          │
          ├───────────────────────────────┤
          │           ...                 │
          └───────────────────────────────┘
```

### Table 5-9: SUBACK Return Codes

| Value | Return Code | Description |
|-------|-------------|-------------|
| 0x00 | Success - Maximum QoS 0 | Subscription accepted, max QoS 0 |
| 0x01 | Success - Maximum QoS 1 | Subscription accepted, max QoS 1 |
| 0x02 | Success - Maximum QoS 2 | Subscription accepted, max QoS 2 |
| 0x80 | Failure | Subscription rejected |

> **Note:** The Server might grant a lower maximum QoS than the subscriber requested. The QoS of messages sent to the subscriber will be the minimum of the originally published QoS and the maximum QoS granted by the Server.

### 5.5.3.4 Example

For a SUBSCRIBE with topics "a/b" (QoS 1) and "c/d" (QoS 2) where both succeed:

```
Byte 1: 0x90  (SUBACK packet type)
Byte 2: 0x04  (Remaining Length = 4)
Byte 3: 0x00  (Packet Identifier MSB)
Byte 4: 0x0A  (Packet Identifier LSB = 10)
Byte 5: 0x01  (Return Code for "a/b" = QoS 1 granted)
Byte 6: 0x02  (Return Code for "c/d" = QoS 2 granted)
```
